#!/usr/bin/env bash

OS="Unknown"
unique_deps=()

_determine_os() {
  if [[ -f "/etc/debian_version" ]] ; then OS="debian"; fi
  if [[ `uname` == "Darwin" ]] ; then OS="mac"; fi
}

_install_deps() {
  for i in ${unique_deps[@]}; do
    echo "Installing ${i}..."
    if ! _${i}_installed; then
      eval _${i}_up;
    else
      echo -e "\talready installed."
    fi
  done
}

_load_books() {
  local caller="${1}"
  echo "${caller} is loading..."
  shift
  for i in "${@}"; do

    # Replace - with _
    i=${i//-/_}

    _load_book "${i}.sh"

    # Prepend any deps
    var=$i"_deps[@]"
    deps=("${!var}" "${deps[@]}")

    _load_books "${i}" "${!var}"
  done
}

_load_book() {
  echo -e "\t${1}"
  . "$HOME/.establish/generic/${1}"
  . "$HOME/.establish/${OS}/${1}" 2> /dev/null
}

_load_project_deps() {
  . "depends.sh"
}

_trim_duplicates() {
  unique_deps=$( awk 'BEGIN{RS=ORS=" "}!a[$0]++' <<<${deps[@]} );
  unique_deps=${unique_deps//-/_}
}


_determine_os
_load_project_deps
_load_books "depends.sh" "${deps[@]}"
_trim_duplicates
_install_deps
